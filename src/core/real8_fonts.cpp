#include "real8_fonts.h"
#include <cstring>

// --------------------------------------------------------------------------
// 4x6 STANDARD FONT
// --------------------------------------------------------------------------
static const uint8_t p8_4x6_table[95][6] = {
    {0, 0, 0, 0, 0, 0}, {0x40, 0x40, 0x40, 0x00, 0x40, 0}, {0xA0, 0xA0, 0, 0, 0, 0},
    {0xA0, 0xE0, 0xA0, 0xE0, 0xA0, 0}, {0x60, 0xC0, 0x40, 0x60, 0xC0, 0}, {0x80, 0x20, 0x40, 0x80, 0x20, 0},
    {0x40, 0xA0, 0x40, 0xA0, 0xA0, 0}, {0x40, 0x40, 0, 0, 0, 0}, {0x40, 0x80, 0x80, 0x80, 0x40, 0},
    {0x40, 0x20, 0x20, 0x20, 0x40, 0}, {0, 0xA0, 0x40, 0xA0, 0, 0}, {0, 0x40, 0xE0, 0x40, 0, 0},
    {0, 0, 0, 0, 0x40, 0x80}, {0, 0, 0xE0, 0, 0, 0}, {0, 0, 0, 0, 0x40, 0},
    {0x20, 0x20, 0x40, 0x80, 0x80, 0}, {0xE0, 0xA0, 0xA0, 0xA0, 0xE0, 0}, {0x40, 0xC0, 0x40, 0x40, 0xE0, 0},
    {0xE0, 0x20, 0xE0, 0x80, 0xE0, 0}, {0xE0, 0x20, 0x60, 0x20, 0xE0, 0}, {0xA0, 0xA0, 0xE0, 0x20, 0x20, 0},
    {0xE0, 0x80, 0xE0, 0x20, 0xE0, 0}, {0xE0, 0x80, 0xE0, 0xA0, 0xE0, 0}, {0xE0, 0x20, 0x20, 0x40, 0x40, 0},
    {0xE0, 0xA0, 0xE0, 0xA0, 0xE0, 0}, {0xE0, 0xA0, 0xE0, 0x20, 0xE0, 0}, {0, 0x40, 0, 0x40, 0, 0},
    {0, 0x40, 0, 0x40, 0x80, 0}, {0x20, 0x40, 0x80, 0x40, 0x20, 0}, {0, 0xE0, 0, 0xE0, 0, 0},
    {0x80, 0x40, 0x20, 0x40, 0x80, 0}, {0xE0, 0x20, 0x40, 0, 0x40, 0}, {0x70, 0x90, 0xB0, 0x90, 0x70, 0},
    {0x40, 0xA0, 0xE0, 0xA0, 0xA0, 0}, {0xC0, 0xA0, 0xC0, 0xA0, 0xC0, 0}, {0xE0, 0x80, 0x80, 0x80, 0xE0, 0},
    {0xC0, 0xA0, 0xA0, 0xA0, 0xC0, 0}, {0xE0, 0x80, 0xC0, 0x80, 0xE0, 0}, {0xE0, 0x80, 0xC0, 0x80, 0x80, 0},
    {0xE0, 0x80, 0xA0, 0xA0, 0xE0, 0}, {0xA0, 0xA0, 0xE0, 0xA0, 0xA0, 0}, {0xE0, 0x40, 0x40, 0x40, 0xE0, 0},
    {0x20, 0x20, 0x20, 0xA0, 0x40, 0}, {0xA0, 0xC0, 0x80, 0xC0, 0xA0, 0}, {0x80, 0x80, 0x80, 0x80, 0xE0, 0},
    {0xA0, 0xE0, 0xA0, 0xA0, 0xA0, 0}, {0xA0, 0xE0, 0xA0, 0xA0, 0xA0, 0}, {0xE0, 0xA0, 0xA0, 0xA0, 0xE0, 0},
    {0xC0, 0xA0, 0xC0, 0x80, 0x80, 0}, {0xE0, 0xA0, 0xA0, 0xE0, 0x20, 0}, {0xC0, 0xA0, 0xC0, 0xA0, 0xA0, 0},
    {0xE0, 0x80, 0xE0, 0x20, 0xE0, 0}, {0xE0, 0x40, 0x40, 0x40, 0x40, 0}, {0xA0, 0xA0, 0xA0, 0xA0, 0xE0, 0},
    {0xA0, 0xA0, 0xA0, 0xA0, 0x40, 0}, {0xA0, 0xA0, 0xA0, 0xE0, 0xA0, 0}, {0xA0, 0xA0, 0x40, 0xA0, 0xA0, 0},
    {0xA0, 0xA0, 0x40, 0x40, 0x40, 0}, {0xE0, 0x20, 0x40, 0x80, 0xE0, 0}, {0x60, 0x40, 0x40, 0x40, 0x60, 0},
    {0x80, 0x80, 0x40, 0x20, 0x20, 0}, {0xC0, 0x40, 0x40, 0x40, 0xC0, 0}, {0x40, 0xA0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0xE0, 0}, {0x80, 0x40, 0, 0, 0, 0}, {0, 0xE0, 0x20, 0xE0, 0xE0, 0},
    {0x80, 0x80, 0xC0, 0xA0, 0xC0, 0}, {0, 0xE0, 0x80, 0x80, 0xE0, 0}, {0x20, 0x20, 0x60, 0xA0, 0x60, 0},
    {0, 0xE0, 0xE0, 0x80, 0xE0, 0}, {0x60, 0x80, 0xC0, 0x80, 0x80, 0}, {0, 0xE0, 0xA0, 0xE0, 0x20, 0xC0},
    {0x80, 0x80, 0xC0, 0xA0, 0xA0, 0}, {0x40, 0, 0x40, 0x40, 0x40, 0}, {0x20, 0, 0x20, 0x20, 0xA0, 0x40},
    {0x80, 0xA0, 0xC0, 0xA0, 0xA0, 0}, {0x40, 0x40, 0x40, 0x40, 0x40, 0}, {0, 0xE0, 0xA0, 0xA0, 0xA0, 0},
    {0, 0xE0, 0xA0, 0xA0, 0xA0, 0}, {0, 0xE0, 0xA0, 0xA0, 0xE0, 0}, {0, 0xC0, 0xA0, 0xC0, 0x80, 0x80},
    {0, 0x60, 0xA0, 0x60, 0x20, 0x20}, {0, 0xE0, 0x80, 0x80, 0x80, 0}, {0, 0xE0, 0x80, 0xE0, 0x20, 0xC0},
    {0x40, 0xE0, 0x40, 0x40, 0x60, 0}, {0, 0xA0, 0xA0, 0xA0, 0xE0, 0}, {0, 0xA0, 0xA0, 0x40, 0x40, 0},
    {0, 0xA0, 0xA0, 0xE0, 0xA0, 0}, {0, 0xA0, 0x40, 0x40, 0xA0, 0}, {0, 0xA0, 0xA0, 0xE0, 0x20, 0xC0},
    {0, 0xE0, 0x20, 0x40, 0xE0, 0}, {0x20, 0x40, 0x80, 0x40, 0x20, 0}, {0x40, 0x40, 0x40, 0x40, 0x40, 0},
    {0x80, 0x40, 0x20, 0x40, 0x80, 0}, {0x40, 0xA0, 0, 0, 0, 0}
};

static const uint8_t p8_special_table[32][6] = {
    {0x00,0x00,0x00,0x00,0x00,0x00}, {0xA0,0x50,0xA0,0x50,0xA0,0x00}, {0x80,0xE0,0xA0,0x20,0x20,0x00}, 
    {0x40,0x40,0x40,0xA0,0x40,0x00}, {0x00,0x50,0x00,0x50,0x00,0x00}, {0x40,0xE0,0x40,0xE0,0x40,0x00}, 
    {0x60,0xF0,0xF0,0x60,0x00,0x00}, {0x40,0xA0,0xE0,0x40,0x00,0x00}, {0x40,0xA0,0x40,0x00,0x00,0x00}, 
    {0x20,0x60,0xE0,0x60,0x20,0x00}, {0xA0,0x00,0xA0,0x00,0x00,0x00}, {0x20,0x40,0xE0,0x40,0x20,0x00}, 
    {0x60,0x90,0x90,0x60,0x00,0x00}, {0x40,0xA0,0x40,0xA0,0x40,0x00}, {0x60,0x90,0x90,0x60,0x00,0x00}, 
    {0x20,0x50,0x20,0x00,0x00,0x00}, {0x40,0xA0,0x40,0x00,0x00,0x00}, {0x40,0x20,0x70,0x20,0x40,0x00}, 
    {0x20,0x70,0xA0,0x20,0x20,0x00}, {0x40,0x20,0x00,0x00,0x00,0x00}, {0x40,0xA0,0x40,0x40,0x40,0x00}, 
    {0x90,0x60,0x30,0x60,0x90,0x00}, {0xF0,0x00,0xF0,0x00,0xF0,0x00}, {0x90,0x60,0x60,0x90,0x00,0x00}, 
    {0xA0,0xA0,0xA0,0xA0,0xA0,0x00}, {0xF0,0xF0,0xF0,0xF0,0xF0,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00}, 
    {0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00}, 
    {0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00}
};

const uint8_t* p8_4x6_bits(uint8_t p8)
{
    if (p8 >= 'a' && p8 <= 'z') p8 = (uint8_t)(p8 - 32);
    if (p8 >= 32 && p8 <= 126) return p8_4x6_table[p8 - 32];
    if (p8 >= 128 && p8 <= 159) return p8_special_table[p8 - 128];

    static const uint8_t box[6] = {0xF0, 0x90, 0x90, 0x90, 0xF0, 0x00};
    return box;
}

// --------------------------------------------------------------------------
// 5x6 MENU FONT
// --------------------------------------------------------------------------
static const uint8_t p8_5x6_table[95][6] = { 
  {0x00,0x00,0x00,0x00,0x00,0x00}, {0x80,0x80,0x80,0x80,0x00,0x80}, {0xA0,0xA0,0x00,0x00,0x00,0x00},
  {0xA0,0xF0,0xA0,0xF0,0xA0,0x00}, {0x40,0xE0,0xC0,0x60,0xE0,0x40}, {0x90,0x20,0x40,0x80,0x90,0x00},
  {0x60,0x90,0x60,0x90,0x60,0x00}, {0x80,0x80,0x00,0x00,0x00,0x00}, {0x40,0x80,0x80,0x80,0x40,0x00},
  {0x80,0x40,0x40,0x40,0x80,0x00}, {0xA0,0x40,0xE0,0x40,0xA0,0x00}, {0x00,0x40,0xE0,0x40,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x80,0x80}, {0x00,0x00,0xE0,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x80,0x00},
  {0x20,0x20,0x40,0x80,0x80,0x00}, {0x60,0x90,0x90,0x90,0x60,0x00}, {0x40,0xC0,0x40,0x40,0xE0,0x00},
  {0xE0,0x10,0x60,0x80,0xF0,0x00}, {0xE0,0x10,0x60,0x10,0xE0,0x00}, {0x20,0x60,0xA0,0xF0,0x20,0x00},
  {0xF0,0x80,0xE0,0x10,0xE0,0x00}, {0x60,0x80,0xE0,0x90,0x60,0x00}, {0xF0,0x10,0x20,0x40,0x40,0x00},
  {0x60,0x90,0x60,0x90,0x60,0x00}, {0x60,0x90,0x70,0x10,0x60,0x00}, {0x00,0x80,0x00,0x80,0x00,0x00},
  {0x00,0x80,0x00,0x80,0x80,0x00}, {0x20,0x40,0x80,0x40,0x20,0x00}, {0x00,0xE0,0x00,0xE0,0x00,0x00},
  {0x80,0x40,0x20,0x40,0x80,0x00}, {0x60,0x90,0x20,0x00,0x20,0x00}, {0x60,0x90,0xB0,0x80,0x70,0x00},
  {0x60,0x90,0xF0,0x90,0x90,0x00}, {0xE0,0x90,0xE0,0x90,0xE0,0x00}, {0x70,0x80,0x80,0x80,0x70,0x00},
  {0xE0,0x90,0x90,0x90,0xE0,0x00}, {0xF0,0x80,0xE0,0x80,0xF0,0x00}, {0xF0,0x80,0xE0,0x80,0x80,0x00},
  {0x70,0x80,0xB0,0x90,0x70,0x00}, {0x90,0x90,0xF0,0x90,0x90,0x00}, {0xE0,0x40,0x40,0x40,0xE0,0x00},
  {0x10,0x10,0x10,0x90,0x60,0x00}, {0x90,0xA0,0xC0,0xA0,0x90,0x00}, {0x80,0x80,0x80,0x80,0xF0,0x00},
  {0x90,0xF0,0x90,0x90,0x90,0x00}, {0x90,0xD0,0xB0,0x90,0x90,0x00}, {0x60,0x90,0x90,0x90,0x60,0x00},
  {0xE0,0x90,0xE0,0x80,0x80,0x00}, {0x60,0x90,0x90,0xA0,0x50,0x00}, {0xE0,0x90,0xE0,0xA0,0x90,0x00},
  {0x70,0x80,0x60,0x10,0xE0,0x00}, {0xE0,0x40,0x40,0x40,0x40,0x00}, {0x90,0x90,0x90,0x90,0x60,0x00},
  {0x90,0x90,0x90,0x60,0x60,0x00}, {0x90,0x90,0x90,0xF0,0x90,0x00}, {0x90,0x90,0x60,0x90,0x90,0x00},
  {0x90,0x90,0x60,0x40,0x40,0x00}, {0xF0,0x10,0x60,0x80,0xF0,0x00}, {0xE0,0x80,0x80,0x80,0xE0,0x00},
  {0x80,0x80,0x40,0x20,0x20,0x00}, {0xE0,0x20,0x20,0x20,0xE0,0x00}, {0x40,0xA0,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0xF0,0x00}, {0x80,0x40,0x00,0x00,0x00,0x00}, {0x00,0x60,0x90,0xF0,0x90,0x00},
  {0x80,0xE0,0x90,0x90,0xE0,0x00}, {0x00,0x60,0x80,0x80,0x60,0x00}, {0x10,0x70,0x90,0x90,0x70,0x00},
  {0x60,0x90,0xF0,0x80,0x70,0x00}, {0x30,0x40,0xE0,0x40,0x40,0x00}, {0x70,0x90,0x90,0x70,0x10,0xE0},
  {0x80,0xE0,0x90,0x90,0x90,0x00}, {0x40,0x00,0x40,0x40,0x40,0x00}, {0x20,0x00,0x20,0x20,0xA0,0x40},
  {0x80,0x90,0xA0,0xC0,0xA0,0x00}, {0x40,0x40,0x40,0x40,0x40,0x00}, {0x00,0xE0,0xA0,0xA0,0xA0,0x00},
  {0x00,0xE0,0x90,0x90,0x90,0x00}, {0x00,0x60,0x90,0x90,0x60,0x00}, {0x00,0xE0,0x90,0x90,0xE0,0x80},
  {0x00,0x70,0x90,0x90,0x70,0x10}, {0x00,0xA0,0xC0,0x80,0x80,0x00}, {0x00,0x70,0xC0,0x30,0xE0,0x00},
  {0x40,0xE0,0x40,0x40,0x30,0x00}, {0x00,0x90,0x90,0x90,0x70,0x00}, {0x00,0x90,0x90,0x60,0x60,0x00},
  {0x00,0x90,0x90,0xF0,0x90,0x00}, {0x00,0x90,0x60,0x60,0x90,0x00}, {0x00,0x90,0x90,0x70,0x10,0xE0},
  {0x00,0xF0,0x20,0x40,0xF0,0x00}, {0x20,0x40,0x80,0x40,0x20,0x00}, {0x40,0x40,0x40,0x40,0x40,0x00},
  {0x80,0x40,0x20,0x40,0x80,0x00}, {0x50,0xA0,0x00,0x00,0x00,0x00}
};

const uint8_t* p8_5x6_bits(uint8_t p8) {
  if (p8 >= 'a' && p8 <= 'z') p8 = (uint8_t)(p8 - 32);
  if (p8 >= 32 && p8 <= 126) return p8_5x6_table[p8 - 32];
  static const uint8_t box[6] = {0xF0,0x90,0x90,0x90,0xF0,0x00}; return box;
}

// --------------------------------------------------------------------------
// UTF8 MAPPING
// --------------------------------------------------------------------------
struct P8UniMap
{
    const char *utf8;
    uint8_t p8;
    int len;
};

static const P8UniMap P8_GLYPHS[] = {
    {"⬅️", 139, 3}, {"➡️", 145, 3}, {"⬆️", 148, 3}, {"⬇️", 131, 3},
    // Add other glyph mappings here if needed
    {NULL, 0, 0}};

std::string convertUTF8toP8SCII(const char *src)
{
    std::string out;
    out.reserve(strlen(src));
    const char *p = src;
    while (*p)
    {
        unsigned char c = (unsigned char)*p;
        if (c < 0x80)
        {
            out.push_back(*p);
            p++;
            continue;
        }
        bool found = false;
        const P8UniMap *map = P8_GLYPHS;
        while (map->utf8)
        {
            if (strncmp(p, map->utf8, map->len) == 0)
            {
                out.push_back((char)map->p8);
                p += map->len;
                found = true;
                break;
            }
            map++;
        }
        if (!found)
        {
            out.push_back(*p);
            p++;
        }
    }
    return out;
}